# Publish Welcome Message Narrative
# Demonstrates: Narrative composition, table references, content selection, bot command execution

[narrative]
name = "publish_welcome"
description = "Generate, select, and publish the best welcome message to Discord server"
skip_content_generation = true
model = "gemini-2.5-flash"

[toc]
order = ["create_channel", "clear_channel", "generate_content", "select_best", "publish_message", "pin_message"]

# Define nested narrative for content generation
[narratives.generate_content]
narrative = "welcome_content_generation"

# Define bot command for getting or creating welcome channel
[bots.create_channel]
platform = "discord"
command = "channels.get_or_create"
guild_id = "1439415903753076859"
name = "welcome"
channel_type = "text"

# Define bot command for clearing channel messages
[bots.clear_channel]
platform = "discord"
command = "messages.clear"
guild_id = "1439415903753076859"
channel_id = "${create_channel.id}"  # Use channel ID from create_channel act
limit = 100

# Define bot command for publishing
[bots.publish_message]
platform = "discord"
command = "messages.send"
guild_id = "1439415903753076859"
channel_id = "${create_channel.id}"  # Use channel ID from create_channel act
content = "{{select_best}}"          # Inject output from select_best act

# Define bot command for pinning message
[bots.pin_message]
platform = "discord"
command = "messages.pin"
guild_id = "1439415903753076859"
channel_id = "${create_channel.id}"  # Use channel ID from create_channel act
message_id = "${publish_message.id}"  # Extract message ID from publish act JSON response

# Define table reference for loading generated messages
[tables.welcome_messages]
table_name = "welcome_messages"
limit = 100
format = "markdown"

[acts]
# Act 1: Create the welcome channel
create_channel = ["bots.create_channel"]

# Act 2: Clear existing messages from welcome channel
clear_channel = ["bots.clear_channel"]

# Act 3: Run welcome content generation to populate the table
generate_content = ["narratives.generate_content"]

# Act 4: Select the best welcome message from generated options
select_best = [
  "tables.welcome_messages",
  """You are reviewing welcome messages for the Botticelli Discord community server.

Review all welcome messages above and:
1. Evaluate them based on clarity, engagement, completeness, Discord markdown formatting, and tone
2. Select the SINGLE BEST message
3. Output ONLY the selected message content (no explanation, no prefix)""",
]

# Act 5: Publish to Discord welcome channel (uses output from select_best)
publish_message = ["bots.publish_message"]

# Act 6: Pin the welcome message to the channel
pin_message = ["bots.pin_message"]
